---
layout: sip
disqus: true
title: SIP-19 Implicit Source Locations
---

**Philipp Haller**<br>
**Eugene Burmako**

**4 April 2012**

**Change history**<br>

* 30 March 2012: First version
* 4 April 2012: Add chaining. Implementation using macros.

## Motivation ##

The Scala compiler's error messages would be nearly useless if they wouldn't provide the corresponding source location, that is, file name, line number, and (some representation of the) character offset, of each error. However, source locations are also very useful outside of the compiler. Libraries and frameworks routinely deal with application- or system-level errors (usually in the form of exceptions), logging, debugging support through tracing, etc. All of these aspects greatly benefit from source location information.

Moreover, embedded domain-specific languages often depend upon source location information for providing useful error messages. Domain-specific languages that employ staging for code generation can use source locations for debug information in the generated code.

This proposal discusses a library extension which provides access to the source location of method invocations. The design is analogous to the way manifests are generated by the compiler, and should therefore be natural to anyone familiar with manifests in Scala.

## Example ##

To obtain the source location for each invocation of a method `debug`, say, one adds an implicit parameter of type `SourceLocation`:

    def debug(message: String)(implicit loc: SourceLocation): Unit = {
      println("@" + loc.fileName + ":" + loc.line + ": " + message)
    }
    
This means that inside the body of the `debug` method, we can access the source location of its current invocation through the `loc` parameter. For example, suppose
we are invoking `debug` on line `34` in a file `"MyApp.scala"`:

    34:    if (debugEnabled) debug("debug message")

Assuming `debugEnabled` evaluates to `true`, the above expression would lead to the following output:

    @MyApp.scala:34: debug message

## The SourceLocation Trait ##

The `SourceLocation` trait is a new type member of the `scala.reflect` package. It has the following members:

    trait SourceLocation {
      /** The name of the source file */
      def fileName: String
    
      /** The line number */
      def line: Int
    
      /** The character offset */
      def charOffset: Int

      /** The `SourceLocation` of the caller's invocation.
       *  `None` if no `SourceLocation` is available.
       */
      def parent: Option[SourceLocation]
    }

## Specification ##

If an implicit parameter of a method or constructor is of type
`SourceLocation`, a source location object is generated based on the
position of the invocation of the method/constructor. If there is
already an implicit value of type `SourceLocation` in scope,
`previous`, say, a reference to `previous` is added to the newly
generated `SourceLocation`. The `previous` `SourceLocation` is then
accessible through the `parent` member of the newly generated
`SourceLocation`.

## Implementation ##

To implement source locations as defined in this proposal, no language
or compiler changes are necessary. Implicit source locations are
generated using a macro definition in the companion object of the
`SourceLocation` trait. This macro is invoked implicitly to obtain an
implicit value of type `SourceLocation`.

An implementation of this proposal can be found at:

    https://github.com/scalamacros/kepler/tree/topic/sip-19

## Experience ##

We have gathered a lot of experience with an extension of this proposal which is part of Scala-Virtualized. The extension adds a subtrait `SourceContext` which in addition provides access to information, such as variable names in the context of a method invocation. However, the advantage of the present proposal is that it does not require a language extension. At the same time, it provides the most important features of the source contexts in Scala-Virtualized.

More information on the source contexts in Scala-Virtualized can be found at:

    https://github.com/TiarkRompf/scala-virtualized/wiki/SourceLocation-and-SourceContext

